```
+-------------------+          +-----------------------+
|   Client Service  |  HTTP    |   Limiter Data Plane  |
| (API Gateway etc) |--------->|  (check & consume)    |
+-------------------+          +----------+------------+
|
| Redis (atomic count)
v
+------------------+
|      Redis       |
+------------------+
|
| Kafka events (async)
v
+-----------------------+         +----------------------+
|  Limiter Accounting   |  MySQL  |       MySQL         |
| (consume Kafka)       |<--------| quota_audit, etc.   |
+-----------------------+         +----------------------+

+-----------------------+  HTTP   +----------------------+
|  Admin / Ops          |-------> | Limiter ControlPlane |
| (Console / Script)    |         | (Policy CRUD/publish)|
+-----------------------+         +----------+-----------+
                                            |
                                            | MySQL (policy, tenant)
                                            v
                                            +----------------------+
                                            |       MySQL         |
                                            | tenant, policy,...  |
                                            +----------------------+

                                              |
                                              | Kafka topic: policy-updates
                                              v
                                    +----------------------+
                                    | Limiter Data Plane   |
                                    | subscribe & hotload  |
                                    +----------------------+
                                    
```

监控：所有服务暴露 Prometheus 指标 -> Prometheus -> Grafana


## 请求限流流程

Client -> Data Plane (/api/v1/check)
1. 根据 tenantId + resourceKey 从本地策略缓存中查策略。
2. 走本地 TokenBucket（内存）fast-path：
   - token 足够 -> 立即允许，异步发送审计事件到 Kafka。
   - token 不足 -> 调用 Redis Lua 脚本（全局原子）slow-path：
   - Redis 成功扣减 -> 允许 + 审计事件
   - Redis 拒绝 -> 拒绝（quota_exceeded 等）
3. 返回 JSON 结果（allowed, remaining, reason, policyVersion）。

## 策略管理&下放

Admin -> ControlPlane (/api/v1/policies)
1. 写入/更新 MySQL policy 表。
2. 调用 /publish API：从 DB 读出策略，封装为消息 -> 发送 Kafka topic: policy-updates。
Data Plane 实例订阅 policy-updates：
3. 收到消息后更新本地策略缓存（例如 Map<tenantId, List<policy>>），支持热更新。

## 审计&计量

Data Plane -> Kafka topic: quota-events

Accounting Service:
1. 消费 quota-events。
2. 批量写入 MySQL.quota_audit（或 ClickHouse）。
3. 后续对账/报表通过查询 quota_audit。