### CheckAndConsume

```
Client                Data Plane                Redis              Kafka                Accounting
  |  POST /check         |                       |                   |                       |
  |--------------------->|                       |                   |                       |
  |                      | 1. 查本地策略缓存       |                   |                       |
  |                      | 2. 本地 TokenBucket 尝试扣减                |                       |
  |                      |   + 允许 -> goto 4                             |
  |                      |   + 不足 -> 3. 调用 Redis Lua 脚本            |
  |                      |---------------------->|                   |                       |
  |                      | <----- 允许 / 拒绝 ---|                   |                       |
  |                      |                                              |
  |                      | 4. 产出审计事件 (QuotaConsumedEvent) -------->|                       |
  |                      |                                              | 5. 批量消费事件        |
  |                      |                                              |---------------------->|
  |                      |                                              |   写入 quota_audit    |
  |                      |                                              |                       |
  | 200 OK + 结果         |                       |                   |                       |
  |<---------------------|                       |                   |                       |
```

### 策略变更&下发

```
Client                Data Plane                Redis              Kafka                Accounting
  |  POST /check         |                       |                   |                       |
  |--------------------->|                       |                   |                       |
  |                      | 1. 查本地策略缓存       |                   |                       |
  |                      | 2. 本地 TokenBucket 尝试扣减                |                       |
  |                      |   + 允许 -> goto 4                             |
  |                      |   + 不足 -> 3. 调用 Redis Lua 脚本            |
  |                      |---------------------->|                   |                       |
  |                      | <----- 允许 / 拒绝 ---|                   |                       |
  |                      |                                              |
  |                      | 4. 产出审计事件 (QuotaConsumedEvent) -------->|                       |
  |                      |                                              | 5. 批量消费事件        |
  |                      |                                              |---------------------->|
  |                      |                                              |   写入 quota_audit    |
  |                      |                                              |                       |
  | 200 OK + 结果         |                       |                   |                       |
  |<---------------------|                       |                   |                       |
```