# Rate Limiter Platform API 文档

版本：v1  
状态：草案（完整版本蓝图）

- 所有时间戳以 毫秒级 Unix 时间戳（long） 传输。
- 所有 API 基础路径以 /api/v1 为例，可按需要调整。
- 认证/鉴权（token、签名）未展开，可以后续加在 Authentication 小节。

## 目录

- [1. 概述](#1-概述)
- [2. 公共约定](#2-公共约定)
    - [2.1 错误响应格式](#21-错误响应格式)
    - [2.2 通用字段说明](#22-通用字段说明)
- [3. Data Plane 接口](#3-data-plane-接口)
    - [3.1 检查并扣减配额 `POST /api/v1/check`](#31-检查并扣减配额-post-apiv1check)
    - [3.2 退还配额（补偿）`POST /api/v1/refund`](#32-退还配额补偿-post-apiv1refund)
- [4. Control Plane 接口（策略管理）](#4-control-plane-接口策略管理)
    - [4.1 创建策略 `POST /api/v1/policies`](#41-创建策略-post-apiv1policies)
    - [4.2 查询策略列表 `GET /api/v1/policies`](#42-查询策略列表-get-apiv1policies)
    - [4.3 查询单个策略 `GET /api/v1/policies/{id}`](#43-查询单个策略-get-apiv1policiesid)
    - [4.4 更新策略 `PUT /api/v1/policies/{id}`](#44-更新策略-put-apiv1policiesid)
    - [4.5 删除策略 `DELETE /api/v1/policies/{id}`](#45-删除策略-delete-apiv1policiesid)
    - [4.6 按租户/资源查询策略 `GET /api/v1/tenants/{tenantId}/policies`](#46-按租户资源查询策略-get-apiv1tenantstenantidpolicies)
    - [4.7 发布/下发策略 `POST /api/v1/tenants/{tenantId}/policies:publish`](#47-发布下发策略-post-apiv1tenantstenantidpoliciespublish)
- [5. Tenant 管理接口](#5-tenant-管理接口)
    - [5.1 创建租户 `POST /api/v1/tenants`](#51-创建租户-post-apiv1tenants)
    - [5.2 查询租户列表 `GET /api/v1/tenants`](#52-查询租户列表-get-apiv1tenants)
    - [5.3 更新租户 `PUT /api/v1/tenants/{tenantId}`](#53-更新租户-put-apiv1tenantstenantid)
- [6. Accounting / 审计查询接口](#6-accounting--审计查询接口)
    - [6.1 查询审计记录 `GET /api/v1/audit`](#61-查询审计记录-get-apiv1audit)
    - [6.2 按 requestId 查询审计详情 `GET /api/v1/audit/{requestId}`](#62-按-requestid-查询审计详情-get-apiv1auditrequestid)
- [7. 健康检查与监控](#7-健康检查与监控)
    - [7.1 健康检查 `GET /actuator/health`](#71-健康检查-get-actuatorhealth)
    - [7.2 指标 `GET /actuator/prometheus`](#72-指标-get-actuatorprometheus)

---

## 1. 概述

本平台提供统一的分布式限流与配额管理能力，包括：

- 实时检查与扣减配额的 Data Plane 接口（低延迟）。
- 支持多租户、多资源、多策略的 Control Plane 策略管理接口。
- 审计与计量的查询接口（用于对账、报表、运营分析）。

所有接口默认使用 `application/json` 格式。认证/鉴权策略可通过 API Key、JWT 或网关统一处理，本文暂未展开。

---

## 2. 公共约定

### 2.1 错误响应格式

所有接口在失败时返回 HTTP 4xx/5xx，并使用统一的错误响应结构：

```json
{
  "code": "string",        // 业务错误码，如 "QUOTA_EXCEEDED", "TENANT_NOT_FOUND"
  "message": "string",     // 人类可读的错误信息
  "requestId": "string",   // 可选：幂等或追踪请求 ID
  "details": {             // 可选：额外信息
    "field": "xxx"
  }
}
```

示例：

```json
{
  "code": "QUOTA_EXCEEDED",
  "message": "Quota exceeded for tenant tenant_001 on resource /api/v1/orders",
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "details": {
    "tenantId": "tenant_001",
    "resourceKey": "/api/v1/orders"
  }
}
```

### 2.2 通用字段说明

- `tenantId`：租户业务 ID（如 `tenant_001`），对应 `tenant.tenant_id`。
- `resourceKey`：受限资源标识（如 API 路径 `/api/v1/orders` 或自定义 key）。
- `requestId`：请求幂等 ID（客户端生成，全局唯一），用于防止重复扣减。
- `timestamp`：发起请求时间，毫秒级 Unix 时间戳（long）。
- `policyVersion`：策略版本字符串（如 `v1`、`v2`），用于追踪策略变更影响。
- `metadata`：扩展字段（JSON 对象），不参与核心限流逻辑，可用于日志/灰度。

---

## 3. Data Plane 接口

### 3.1 检查并扣减配额 `POST /api/v1/check`

**描述**

检查指定租户在指定资源上的配额是否足够，若足够则扣减，并返回允许/拒绝结果。  
本接口是**幂等的**：同一 `requestId` 多次调用不得重复扣减。

**请求**

`POST /api/v1/check`

Header（示例）：

- `Content-Type: application/json`
- `X-Request-Id: <optional>` （若未提供，将以 body 中的 `requestId` 为准）

请求体：

```json
{
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "tokens": 1,
  "timestamp": 1700000000000,
  "metadata": {
    "clientIp": "203.0.113.10",
    "userId": "user_123",
    "traceId": "trace-xxx"
  }
}
```

字段说明：

- `requestId` (string, required)：幂等 ID，建议为 UUID。
- `tenantId` (string, required)：租户业务 ID。
- `resourceKey` (string, required)：资源标识。
- `tokens` (integer, required)：本次请求消耗的 token 数（通常为 1）。
- `timestamp` (long, required)：请求发生时间。
- `metadata` (object, optional)：扩展信息，如 IP、User-Agent、调用方服务名等。

**响应**

成功（HTTP 200）：

```json
{
  "allowed": true,
  "remaining": 9999,
  "policyVersion": "v1",
  "reason": "",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "timestamp": 1700000000000
}
```

拒绝（HTTP 200，业务字段体现拒绝）：

```json
{
  "allowed": false,
  "remaining": 0,
  "policyVersion": "v1",
  "reason": "quota_exceeded",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "timestamp": 1700000000000
}
```

- `allowed`：是否允许。
- `remaining`：估算或精确的剩余配额（视策略与实现，可为 `-1` 表示未知）。
- `reason`：可选，`""`（允许）、`"quota_exceeded"`、`"policy_disabled"`、`"blacklisted"` 等。
- 其余为回显字段。

错误示例（HTTP 400/404）：

```json
{
  "code": "POLICY_NOT_FOUND",
  "message": "No policy found for tenant tenant_999 on resource /api/v1/orders",
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "details": {
    "tenantId": "tenant_999",
    "resourceKey": "/api/v1/orders"
  }
}
```

---

### 3.2 退还配额（补偿） `POST /api/v1/refund`

**描述**

当业务后续发现原请求未实际消耗（例如下游错误、事务回滚等），可以调用 refund 接口退回已扣减的 tokens，保证计费/配额准确性。  
该接口同样应**幂等**：同一个 `refundRequestId` 多次调用退还行为只能生效一次。

**请求**

`POST /api/v1/refund`

```json
{
  "refundRequestId": "16b392ab-9f11-4bb4-bbd3-abcdef012345",
  "originalRequestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "tokens": 1,
  "reason": "downstream_failure",
  "timestamp": 1700000001000,
  "metadata": {
    "note": "payment service timeout, rollback order"
  }
}
```

字段：

- `refundRequestId` (string, required)：本次退款操作的幂等 ID。
- `originalRequestId` (string, required)：对应的原 `check` 请求 ID。
- `tenantId`、`resourceKey`、`tokens`：与原请求匹配。
- `reason`：退款原因。
- `timestamp`：退款操作时间。
- `metadata`：补充信息。

**响应**

成功（HTTP 200）：

```json
{
  "success": true,
  "refundRequestId": "16b392ab-9f11-4bb4-bbd3-abcdef012345",
  "originalRequestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders"
}
```

失败示例（HTTP 400）：

```json
{
  "code": "ORIGINAL_REQUEST_NOT_FOUND",
  "message": "Original request not found or not chargeable",
  "requestId": "16b392ab-9f11-4bb4-bbd3-abcdef012345",
  "details": { }
}
```

---

## 4. Control Plane 接口（策略管理）

### 4.1 创建策略 `POST /api/v1/policies`

**描述**

为指定租户与资源创建一条限流/配额策略。

**请求**

`POST /api/v1/policies`

```json
{
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "policyType": "TOKEN_BUCKET",
  "windowSeconds": 60,
  "capacity": 10000,
  "refillRate": 166.67,
  "burstCapacity": 20000,
  "priority": 10,
  "enabled": true,
  "version": "v1",
  "metadata": {
    "note": "VIP customer orders",
    "tags": ["vip", "priority"]
  },
  "description": "VIP tenant order API quota"
}
```

字段：

- `tenantId` (required)
- `resourceKey` (required)
- `policyType` (required)：`TOKEN_BUCKET` / `FIXED_WINDOW` / `SLIDING_WINDOW`。
- `windowSeconds` (required)：时间窗口（秒）。
- `capacity` (required)：最大请求数。
- `refillRate` (required for TOKEN_BUCKET)：每秒补充 token 数。
- `burstCapacity` (optional)：突发上限。
- `priority` (required)：优先级，数字越大越高。
- `enabled` (required)：是否启用。
- `version` (required)：策略版本。
- `metadata` (optional)：JSON 对象。
- `description` (optional)。

**响应**

成功（HTTP 201）：

```json
{
  "id": 123,
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "policyType": "TOKEN_BUCKET",
  "windowSeconds": 60,
  "capacity": 10000,
  "refillRate": 166.67,
  "burstCapacity": 20000,
  "priority": 10,
  "enabled": true,
  "version": "v1",
  "metadata": { "note": "VIP customer orders" },
  "description": "VIP tenant order API quota",
  "createdAt": "2025-12-30T03:00:00Z",
  "updatedAt": "2025-12-30T03:00:00Z"
}
```

错误（资源冲突，HTTP 409）：

```json
{
  "code": "POLICY_ALREADY_EXISTS",
  "message": "Policy already exists for tenant tenant_001 and resource /api/v1/orders",
  "details": {
    "tenantId": "tenant_001",
    "resourceKey": "/api/v1/orders"
  }
}
```

---

### 4.2 查询策略列表 `GET /api/v1/policies`

**描述**

分页查询所有策略，可按 `tenantId`、`enabled` 等过滤。

**请求**

`GET /api/v1/policies?tenantId=tenant_001&enabled=true&page=1&size=20`

查询参数：

- `tenantId` (optional)
- `enabled` (optional, boolean)
- `page` (optional, default 1)
- `size` (optional, default 20, max 100)

**响应**

```json
{
  "content": [
    {
      "id": 123,
      "tenantId": "tenant_001",
      "resourceKey": "/api/v1/orders",
      "policyType": "TOKEN_BUCKET",
      "windowSeconds": 60,
      "capacity": 10000,
      "refillRate": 166.67,
      "burstCapacity": 20000,
      "priority": 10,
      "enabled": true,
      "version": "v1",
      "metadata": { },
      "description": "VIP tenant order API quota",
      "createdAt": "2025-12-30T03:00:00Z",
      "updatedAt": "2025-12-30T03:00:00Z"
    }
  ],
  "page": 1,
  "size": 20,
  "totalElements": 1,
  "totalPages": 1
}
```

---

### 4.3 查询单个策略 `GET /api/v1/policies/{id}`

**请求**

`GET /api/v1/policies/123`

**响应**

同创建成功的返回结构。

不存在时（HTTP 404）：

```json
{
  "code": "POLICY_NOT_FOUND",
  "message": "Policy 123 not found"
}
```

---

### 4.4 更新策略 `PUT /api/v1/policies/{id}`

**请求**

`PUT /api/v1/policies/123`

```json
{
  "capacity": 20000,
  "refillRate": 333.33,
  "priority": 20,
  "enabled": true,
  "version": "v2",
  "metadata": {
    "note": "Increased quota for promotion"
  },
  "description": "VIP tenant order API quota, promotion period"
}
```

- 允许部分字段更新（业务上可选择全量/部分）。

**响应**

200 + 更新后完整策略对象。

---

### 4.5 删除策略 `DELETE /api/v1/policies/{id}`

**请求**

`DELETE /api/v1/policies/123`

**响应**

- 成功：HTTP 204，无 body。
- 不存在：HTTP 404，返回错误结构。

---

### 4.6 按租户/资源查询策略 `GET /api/v1/tenants/{tenantId}/policies`

**请求**

`GET /api/v1/tenants/tenant_001/policies?resourceKey=/api/v1/orders`

**响应**

```json
[
  {
    "id": 123,
    "tenantId": "tenant_001",
    "resourceKey": "/api/v1/orders",
    "policyType": "TOKEN_BUCKET",
    "windowSeconds": 60,
    "capacity": 10000,
    "refillRate": 166.67,
    "burstCapacity": 20000,
    "priority": 10,
    "enabled": true,
    "version": "v1",
    "metadata": { },
    "description": "VIP tenant order API quota",
    "createdAt": "2025-12-30T03:00:00Z",
    "updatedAt": "2025-12-30T03:00:00Z"
  }
]
```

---

### 4.7 发布/下发策略 `POST /api/v1/tenants/{tenantId}/policies:publish`

**描述**

将某个租户的所有启用策略（或指定策略）发布到 Data Plane，通过 Kafka 或其他配置通道下发。  
这是**控制面到数据面**的控制接口。

**请求**

`POST /api/v1/tenants/tenant_001/policies:publish`

```json
{
  "resourceKeys": ["/api/v1/orders", "/api/v1/payments"],
  "version": "v1",
  "force": false
}
```

- `resourceKeys` (optional)：若为空，表示发布该租户所有策略。
- `version` (optional)：仅发布指定版本策略。
- `force` (optional)：是否强制覆盖 Data Plane 现有缓存。

**响应**

```json
{
  "success": true,
  "tenantId": "tenant_001",
  "publishedCount": 2,
  "message": "Published 2 policies to data plane"
}
```

---

## 5. Tenant 管理接口

### 5.1 创建租户 `POST /api/v1/tenants`

```json
{
  "tenantId": "tenant_001",
  "tenantName": "Alpha Tech Inc",
  "contactEmail": "admin@alpha.com",
  "tier": "VIP",
  "status": "ACTIVE"
}
```

**响应**

```json
{
  "id": 1,
  "tenantId": "tenant_001",
  "tenantName": "Alpha Tech Inc",
  "contactEmail": "admin@alpha.com",
  "tier": "VIP",
  "status": "ACTIVE",
  "createdAt": "2025-12-30T03:00:00Z",
  "updatedAt": "2025-12-30T03:00:00Z"
}
```

---

### 5.2 查询租户列表 `GET /api/v1/tenants`

`GET /api/v1/tenants?tier=VIP&status=ACTIVE&page=1&size=20`

返回分页结构（同策略列表）。

---

### 5.3 更新租户 `PUT /api/v1/tenants/{tenantId}`

示例：

```json
{
  "tenantName": "Alpha Tech Corp",
  "contactEmail": "ops@alpha.com",
  "tier": "ENTERPRISE",
  "status": "ACTIVE"
}
```

---

## 6. Accounting / 审计查询接口

### 6.1 查询审计记录 `GET /api/v1/audit`

**请求**

`GET /api/v1/audit?tenantId=tenant_001&resourceKey=/api/v1/orders&from=1700000000000&to=1700086400000&page=1&size=50&allowed=true`

参数：

- `tenantId` (required)
- `resourceKey` (optional)
- `from` (required)：起始时间戳（毫秒）
- `to` (required)：结束时间戳（毫秒）
- `allowed` (optional)
- `page` / `size` 分页参数

**响应**

```json
{
  "content": [
    {
      "requestId": "req_test_001",
      "tenantId": "tenant_001",
      "resourceKey": "/api/v1/orders",
      "tokens": 1,
      "allowed": true,
      "remaining": 9999,
      "reason": "",
      "policyVersion": "v1",
      "clientIp": "192.168.1.100",
      "userAgent": "curl/7.68.0",
      "latencyMs": 5,
      "timestamp": 1700000100000
    }
  ],
  "page": 1,
  "size": 50,
  "totalElements": 1,
  "totalPages": 1
}
```

---

### 6.2 按 requestId 查询审计详情 `GET /api/v1/audit/{requestId}`

`GET /api/v1/audit/2b8d7c93-0a44-4a90-9e1a-123456789abc`

**响应**

```json
{
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "tokens": 1,
  "allowed": true,
  "remaining": 9999,
  "reason": "",
  "policyVersion": "v1",
  "clientIp": "203.0.113.10",
  "userAgent": "gateway/1.0",
  "latencyMs": 7,
  "timestamp": 1700000000000
}
```

---

## 7. 健康检查与监控

### 7.1 健康检查 `GET /actuator/health`

由 Spring Boot Actuator 提供，所有微服务（Data Plane、Control Plane、Accounting）都开启：

- `GET /actuator/health`：返回整体健康状态。
- 可扩展 Redis、Kafka、MySQL 的自定义 health indicator。

示例：

```json
{
  "status": "UP",
  "components": {
    "db": { "status": "UP", "details": { "database": "MySQL", "hello": 1 } },
    "redis": { "status": "UP" },
    "kafka": { "status": "UP" }
  }
}
```

---

### 7.2 指标 `GET /actuator/prometheus`

所有服务暴露 Prometheus 格式指标：

- `GET /actuator/prometheus`

典型自定义指标：

- `ratelimiter_requests_total{tenantId, resourceKey, result="allowed|denied"}`
- `ratelimiter_check_latency_ms_bucket`
- `ratelimiter_redis_latency_ms_bucket`
- `ratelimiter_kafka_lag`
- `ratelimiter_quota_overdraft_total`

Grafana 面板根据这些指标绘制可视化报表。

---

## 附录：内部事件模型（Kafka）

### 事件 1：配额消费事件（QuotaConsumedEvent）

Topic：`quota-events`

```json
{
  "eventType": "QuotaConsumed",
  "eventId": "uuid",
  "occurredAt": 1700000000000,
  "tenantId": "tenant_001",
  "resourceKey": "/api/v1/orders",
  "requestId": "2b8d7c93-0a44-4a90-9e1a-123456789abc",
  "tokens": 1,
  "allowed": true,
  "reason": "",
  "policyVersion": "v1",
  "clientIp": "203.0.113.10",
  "userAgent": "gateway/1.0",
  "latencyMs": 7
}
```

### 事件 2：策略下发事件（PolicyUpdatedEvent）

Topic：`policy-updates`

```json
{
  "eventType": "PolicyUpdated",
  "eventId": "uuid",
  "occurredAt": 1700000100000,
  "tenantId": "tenant_001",
  "policies": [
    {
      "id": 123,
      "resourceKey": "/api/v1/orders",
      "policyType": "TOKEN_BUCKET",
      "windowSeconds": 60,
      "capacity": 10000,
      "refillRate": 166.67,
      "burstCapacity": 20000,
      "priority": 10,
      "enabled": true,
      "version": "v1",
      "metadata": { }
    }
  ]
}
```
